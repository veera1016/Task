name: Deploy to EC2

on:
push:
branches:
- master

jobs:
deploy:
runs-on: ubuntu-latest
environment: dev
 steps:
  - name: Checkout code
    uses: actions/checkout@v2

  - name: Install AWS CLI
    run: |
      sudo apt-get update
      sudo apt-get install -y awscli
  
  - name: Configure AWS credentials
    uses: aws-actions/configure-aws-credentials@v1
    with:
      aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      aws-region: "us-east-1"

  - name: Install Node.js and npm
    uses: actions/setup-node@v2
    with:
      node-version: '16'

  - name: Deploy to EC2
    uses: appleboy/ssh-action@master
    with:
      host: ${{ secrets.EC2_HOST }}
      username: ${{ secrets.EC2_USERNAME }}
      key: ${{ secrets.EC2_PRIVATE_KEY }}
      port: 22
      script: |
       cd /home/ubuntu
       git pull origin master  # Ensure latest changes are pulled
       npm install           # Install any new dependencies
       npm run build         # Build the application
       sudo pm2 restart all || pm2 start dist/main.js
